name: RunTests

# Connected workflows are:
# 1. 📍RunTests - run_tests.yml
# 2. CreateReleasePR - create_release_pr.yml
# 3. Release - release.yml
# 4. ProxyUpdateSubmoduleRefs - valor-modulis/proxy_update_submodule_refs.yml

# checks code of a PR as a precondition for merges

on:
  # Test PRs generated by actions
  workflow_dispatch:
    inputs:
      ref:
        description: Branch (release/pr-123) or commit hash (40 chars) to test
        required: true
        type: string
  # Test PRs and commits to PRs from users
  pull_request_target:
    branches: [main]
    types: [opened, synchronize]

jobs:
  run_tests:
    runs-on: windows-latest

    steps:
      - name: Get PR sha
        id: get_ref
        run: |
          if('${{ github.event_name }}' -eq 'workflow_dispatch') {
            $REFERENCE = '${{ github.event.inputs.ref }}'
          } else {
            $REFERENCE = '${{ github.event.pull_request.head.ref }}'
          }
          Write-Output "REFERENCE=$REFERENCE" >> $env:GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.get_ref.outputs.REFERENCE }}
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run Tests
        shell: pwsh
        id: testresults
        run: |
          Set-PSRepository psgallery -InstallationPolicy trusted
          Install-Module -Name Pester -Confirm:$false -Force
          Invoke-Pester
